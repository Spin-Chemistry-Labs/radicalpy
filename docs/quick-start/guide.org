#+PROPERTY: header-args:python  :session *python* :results output

#+begin_src python :results silent
  import sys

  from radicalpy.simulation import Molecule

  sys.stderr = sys.stdout
#+end_src


* Using the molecule database

#+begin_src python :exports both
  flavin = Molecule(radical="flavin_anion",
                    nuclei=["H25"])
  print(flavin)
#+end_src

#+RESULTS:
: Molecule: flavin_anion
:   HFCs: [array([[ 0.47570582,  0.04192216, -0.00921916],
:        [ 0.04192216,  0.4626044 , -0.00827001],
:        [-0.00921916, -0.00827001,  0.42560999]])]
:   Multiplicities: [2]
:   Magnetogyric ratios (mT): [267522.18744]
:   Number of particles: 1


* Helpful error messages

#+begin_src python :exports both
  try:
      Molecule("adenine_cation", ["buz"])
  except ValueError as e:
      print(e)
#+end_src

#+RESULTS:
: Available nuclei below.
: N6-H2 (hfc = -0.66)
: N6-H1 (hfc = -0.63)
: C8-H (hfc = -0.55)


* Using the isotope database

#+begin_src python :exports both
  print(Molecule(nuclei=["1H", "14N"],
                 hfcs=[0.41, 1.82]))
#+end_src

#+RESULTS:
: Molecule: N/A
:   HFCs: [0.41, 1.82]
:   Multiplicities: [2, 3]
:   Magnetogyric ratios (mT): [267522.18744, 19337.792]
:   Number of particles: 2


* Custom molecules

#+begin_src python :exports both
  print(Molecule("my_flavin",
                 multiplicities=[2],
                 gammas_mT=[267522.18744],
                 hfcs=[0.5]))
#+end_src

#+RESULTS:
: Molecule: my_flavin
:   HFCs: [0.5]
:   Multiplicities: [2]
:   Magnetogyric ratios (mT): [267522.18744]
:   Number of particles: 1

#+begin_src python :exports both
  Z = Molecule("kryptonite")
  print(Z)
#+end_src

#+RESULTS:
: Molecule: kryptonite
:   HFCs: []
:   Multiplicities: []
:   Magnetogyric ratios (mT): []
:   Number of particles: 0

* Building a simulation object

#+begin_src python :exports both
  import radicalpy as rp
  import matplotlib.pyplot as plt

  sim = rp.simulation.HilbertSimulation([flavin, Z])
  print(sim)
#+end_src

#+RESULTS:
#+begin_example
Number of electrons: 2
Number of nuclei: 1
Number of particles: 3
Multiplicities: [2, 2, 2]
Magnetogyric ratios (mT): [-176085963.023, -176085963.023, 267522.18744]
Nuclei: ['H25']
Couplings: [0]
HFCs (mT): [array([[ 0.47570582,  0.04192216, -0.00921916],
       [ 0.04192216,  0.4626044 , -0.00827001],
       [-0.00921916, -0.00827001,  0.42560999]])]
#+end_example

#+begin_src python :exports both :results output file
  H = sim.total_hamiltonian(B=0, D=0, J=0)
  plt.clf()
  plt.spy(H)
  fname = "img/hamiltonian.png"
  plt.savefig(fname)
  print(fname)
#+end_src

#+RESULTS:
[[file:img/hamiltonian.png]]


* Time evolution

#+begin_src python :exports both :results output file
  import numpy as np
  from radicalpy.simulation import State

  time = np.arange(0, 2e-6, 5e-9)
  rhos = sim.time_evolution(State.SINGLET, time, H)

  k = 3e6
  kinetics=[rp.kinetics.Exponential(k)]
  time_evol = sim.product_probability(State.TRIPLET, rhos)

  sim.apply_hilbert_kinetics(time, time_evol, kinetics)

  product_yield, product_yield_sum = sim.product_yield(time_evol, time, k)
  x = time * 1e6

  plt.clf()
  plt.plot(x, time_evol, color="red", linewidth=2)
  plt.fill_between(x, product_yield, color="blue", alpha=0.2)
  plt.xlabel("Time ($\mu s$)")
  plt.ylabel("Probability")
  plt.ylim([0, 1])
  plt.legend([r"$P_i(t)$", r"$\Phi_i$"])
  plt.suptitle(f"PY = {product_yield_sum}")

  fname = "img/time_evolution.png"
  plt.savefig(fname)
  print(fname)
#+end_src

#+RESULTS:
[[file:img/time_evolution.png]]


* Monte Carlo random walk

** 3D random walk

#+begin_src python :exports both :results output file
  np.random.seed(42)

  t = np.arange(0, 8e-6, 40e-12)
  r_min = 0.5e-9 / 2
  r_max = 1.5e-9
  r = (r_min) + np.random.sample() * ((r_max) - (r_min))
  x0, y0, z0 = r, 0, 0
  mutual_diffusion = 1e-6 / 10000

  delta_r = rp.classical.get_delta_r(mutual_diffusion, t[1] - t[0])
  pos, dist, ang = rp.classical.randomwalk_3d(
      len(t), x0, y0, z0, delta_r, r_min, r_max
  )

  rp.plot.monte_carlo_caged(pos, r_max)

  fname = "img/monte_carlo_3d.png"
  plt.savefig(fname)
  print(fname)
#+end_src

#+RESULTS:
[[file:img/monte_carlo_3d.png]]


** Distance

#+begin_src python :exports both :results output file
  t_convert = 1e3

  plt.clf()
  plt.grid(False)
  plt.axis("on")
  plt.rc("axes", edgecolor="k")
  plt.plot(t / t_convert, dist * 1e9, "r")
  plt.title("Time evolution of radical pair separation", size=16)
  plt.xlabel("$t$ ($\mu s$)", size=14)
  plt.ylabel("$r$ (nm)", size=14)
  plt.tick_params(labelsize=14)

  fname = "img/monte_carlo_distance.png"
  plt.savefig(fname)
  print(fname)
#+end_src

#+RESULTS:
[[file:img/monte_carlo_distance.png]]

** Exchange interaction estimation

#+begin_src python :exports both :results output file
  J = rp.estimations.exchange_interaction_monte_carlo(dist)

  plt.clf()
  plt.grid(False)
  plt.axis("on")
  plt.rc("axes", edgecolor="k")
  plt.plot(t / t_convert, J)
  plt.title("Time evolution of the exchange interaction", size=16)
  plt.xlabel("$t$ ($\mu s$)", size=14)
  plt.ylabel("$J$ (mT)", size=14)
  plt.tick_params(labelsize=14)

  fname = "img/monte_carlo_exchange.png"
  plt.savefig(fname)
  print(fname)
#+end_src

#+RESULTS:
[[file:img/monte_carlo_exchange.png]]

** Dipolar interaction

#+begin_src python :exports both :results output file
  D = rp.estimations.dipolar_interaction_monte_carlo(dist, ang)

  plt.clf()
  plt.grid(False)
  plt.axis("on")
  plt.rc("axes", edgecolor="k")
  plt.plot(t / t_convert, D, "g")
  plt.title("Time evolution of the dipolar interaction", size=16)
  plt.xlabel("$t$ ($\mu s$)", size=14)
  plt.ylabel("$D$ (mT)", size=14)
  plt.tick_params(labelsize=14)

  fname = "img/monte_carlo_dipolar.png"
  plt.savefig(fname)
  print(fname)
#+end_src


#+RESULTS:
[[file:img/monte_carlo_dipolar.png]]


** Autocorrelation

#+begin_src python :exports both :results output file
  acf_j = rp.utils.autocorrelation(J, factor=2)

  t = np.linspace(0, t[-1], len(acf_j))

  # ax.set_facecolor("none")
  plt.clf()
  plt.grid(False)
  plt.axis("on")
  plt.xscale("log")
  plt.rc("axes", edgecolor="k")
  plt.plot(t, acf_j, "b", label="J")
  plt.xlabel(r"$\tau$ (s)", size=14)
  plt.ylabel(r"$g_J(\tau)$", size=14)
  plt.title("Autocorrelation: exchange interaction", size=16)
  plt.tick_params(labelsize=14)

  fname = "img/monte_carlo_autocorrelation.png"
  plt.savefig(fname)
  print(fname)
#+end_src

#+RESULTS:
[[file:img/monte_carlo_autocorrelation.png]]


* Document still not finished! Sorry!

